

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/avatar.jpg">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="CarlChu">
  <meta name="keywords" content="">
  
    <meta name="description" content="SpringCloud Alibaba版本说明 · alibaba&#x2F;spring-cloud-alibaba Wiki · GitHub 12345678910111213141516&lt;!--spring cloud 2021.0.1--&gt;            &lt;dependency&gt;                &lt;groupId&gt;org.spri">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringCloud Alibaba">
<meta property="og:url" content="https://carl-chu.github.io/2022/09/29/SpringCloud%20Alibaba/index.html">
<meta property="og:site_name" content="CarlChu&#39;s blog">
<meta property="og:description" content="SpringCloud Alibaba版本说明 · alibaba&#x2F;spring-cloud-alibaba Wiki · GitHub 12345678910111213141516&lt;!--spring cloud 2021.0.1--&gt;            &lt;dependency&gt;                &lt;groupId&gt;org.spri">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2022-09-29T19:35:00.000Z">
<meta property="article:modified_time" content="2023-05-13T15:27:33.945Z">
<meta property="article:author" content="CarlChu">
<meta name="twitter:card" content="summary_large_image">
  
  
  
  <title>SpringCloud Alibaba - CarlChu&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"carl-chu.github.io","root":"/","version":"1.9.4","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>CarlChu</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="SpringCloud Alibaba"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-09-29 19:35" pubdate>
          2022年9月29日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          18k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          150 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">SpringCloud Alibaba</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="SpringCloud-Alibaba"><a href="#SpringCloud-Alibaba" class="headerlink" title="SpringCloud Alibaba"></a>SpringCloud Alibaba</h1><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/%E7%89%88%E6%9C%AC%E8%AF%B4%E6%98%8E">版本说明 · alibaba&#x2F;spring-cloud-alibaba Wiki · GitHub</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--spring cloud 2021.0.1--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.cloud.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--Spring cloud alibaba 2021.0.1.0--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-dependencies<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>$&#123;spring.cloud.alibaba.version&#125;<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<h2 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h2><p><a target="_blank" rel="noopener" href="https://github.com/alibaba/spring-cloud-alibaba/wiki/Nacos-discovery">Nacos discovery · alibaba&#x2F;spring-cloud-alibaba Wiki · GitHub</a></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>下载客户端</p>
<p>默认集群模式（单机需要进行修改）：编辑nacos\bin\startup.cmd，将<code>set MODE=&quot;cluster&quot;</code>改为<code>set MODE=&quot;standalone&quot;</code></p>
<p>可在<code>nacos\conf\application.properties</code>中添加数据源</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment">### If use MySQL as datasource:</span><br><span class="hljs-attr">spring.datasource.platform</span>=<span class="hljs-string">mysql</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### Count of DB:</span><br><span class="hljs-attr">db.num</span>=<span class="hljs-string">1</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">### Connect URL of DB:</span><br><span class="hljs-attr">db.url.0</span>=<span class="hljs-string">jdbc:mysql://127.0.0.1:3306/nacos_config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class="hljs-attr">db.user.0</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">db.password.0</span>=<span class="hljs-string">17221273</span><br></code></pre></td></tr></table></figure>

<p>账号密码默认：nacos</p>
<p>集群部署：</p>
<p>使用nginx进行反向代理，编辑nginx.conf文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs conf">upstream nacoscluster &#123;<br>	server 127.0.0.1:8848;<br>	server 127.0.0.1:8849;<br>	server 127.0.0.1:8850;<br>&#125;<br>server &#123;<br>	listen 8847;	#nginx服务监听的端口<br>	server_name localhost;<br>	<br>	location /nacos/&#123;	#/nacos值的是路径前缀，localhost:8847/nacos<br>		proxy_pass http://nacoscluster/nacos/;<br>	&#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>需要修改启动模式为cluster，或使用命令<code> -m -standalone</code></p>
<p>添加<code>cluster.conf</code>文件写入其他nacos的地址</p>
<p>将项目中nacos注册的地址<code>spring.clou.nacos.server-addr</code>修改为nginx监听的地址</p>
<h2 id="负载均衡Ribbon"><a href="#负载均衡Ribbon" class="headerlink" title="负载均衡Ribbon"></a>负载均衡Ribbon</h2><h2 id="负载均衡LoadBalancer"><a href="#负载均衡LoadBalancer" class="headerlink" title="负载均衡LoadBalancer"></a>负载均衡LoadBalancer</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-loadbalancer<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Firstlucky77/article/details/124969555">微服务生态组件之Spring Cloud LoadBalancer详解和源码分析_Firstlucky77的博客-CSDN博客_spring.cloud.loadbalancer</a></p>
<h2 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>配置类上使用<code>@EnableFeignClients</code>开启openfeign</p>
<h3 id="OpenFeign各种问题"><a href="#OpenFeign各种问题" class="headerlink" title="OpenFeign各种问题"></a>OpenFeign各种问题</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_62421895/article/details/126481931">(1条消息) 谈谈Spring Cloud OpenFeign远程调用性能优化_java熬夜党的博客-CSDN博客</a></p>
<h3 id="日志配置"><a href="#日志配置" class="headerlink" title="日志配置"></a>日志配置</h3><p>全局配置：</p>
<p>使用<code>@Configuration</code>会将配置的作用所有的服务提供方</p>
<p>局部配置：</p>
<p>1.通过配置类：如果针对某一个服务进行配置，就不要加@Configuration</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignConfig</span> &#123;<br>	<br>    <span class="hljs-comment">//Logger是feign包下的</span><br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Logger.Level <span class="hljs-title function_">feignLoggerLevel</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> Logger.Level.FULL;<br>    &#125;<br><br>&#125;<br><br><br><span class="hljs-meta">@FeignClient(name = &quot;service-bravo&quot;, configuration = FeignConfig.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BravoFeign</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/bravo-test/getBravoTestString&quot;)</span><br>    String <span class="hljs-title function_">getBravoTestString</span><span class="hljs-params">()</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>2.通过配置文件</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span> <br>   	 <span class="hljs-comment">#服务名</span><br>      <span class="hljs-attr">service-alpha:</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">FULL</span><br></code></pre></td></tr></table></figure>

<h3 id="契约配置"><a href="#契约配置" class="headerlink" title="契约配置"></a>契约配置</h3><p>老版本springcloud使用的是feign，netflix停更后springcloud改用openFeign且支持了springmvc注解，契约配置是对老版本SpringCloud使用的feign的注解的兼容</p>
<p>注意：修改契约配置后，feign接口不再支持springmvc的注解，需要使用feign原生的注解</p>
<h3 id="超时时间配置"><a href="#超时时间配置" class="headerlink" title="超时时间配置"></a>超时时间配置</h3><p>全局配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Request.Options <span class="hljs-title function_">options</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Request</span>.Options(<span class="hljs-number">5</span>, TimeUnit.SECONDS,<span class="hljs-number">3</span>, TimeUnit.SECONDS, <span class="hljs-literal">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>



<p>yaml配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">feign:</span><br>  <span class="hljs-attr">client:</span><br>    <span class="hljs-attr">config:</span><br>      <span class="hljs-attr">service-alpha:</span> <span class="hljs-comment">#服务名</span><br>        <span class="hljs-attr">loggerLevel:</span> <span class="hljs-string">FULL</span><br>        <span class="hljs-comment">#连接超时时间，默认2秒</span><br>        <span class="hljs-attr">connectTimeout:</span> <span class="hljs-number">5000</span><br><span class="hljs-comment">#        请求超时时间，默认5秒</span><br>        <span class="hljs-attr">readTimeout:</span> <span class="hljs-number">5000</span><br></code></pre></td></tr></table></figure>



<h3 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FeignRequestInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RequestInterceptor</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">apply</span><span class="hljs-params">(RequestTemplate requestTemplate)</span> &#123;<br><br>        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">servletRequestAttributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes)RequestContextHolder.getRequestAttributes();<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> servletRequestAttributes.getRequest();<br>        Enumeration&lt;String&gt; headerNames = request.getHeaderNames();<br>        <span class="hljs-keyword">while</span> (headerNames.hasMoreElements())&#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">s</span> <span class="hljs-operator">=</span> headerNames.nextElement();<br>            <span class="hljs-type">String</span> <span class="hljs-variable">header</span> <span class="hljs-operator">=</span> request.getHeader(s);<br>            System.out.println(<span class="hljs-string">&quot;[header] key:&quot;</span> + s + <span class="hljs-string">&quot;, value:&quot;</span> + header);<br>        &#125;<br><br>        log.info(<span class="hljs-string">&quot;feign拦截器：&#123;&#125;&quot;</span>, requestTemplate.toString());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="配置中心Nacos-config"><a href="#配置中心Nacos-config" class="headerlink" title="配置中心Nacos-config"></a>配置中心Nacos-config</h2><p>权限功能的开启需要在nacos配置文件中配置<code>nacos.core.auth.enabled=true</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>spring-cloud-dependencies 2020.0.0 版本不在默认加载bootstrap 文件，如果需要加载bootstrap 文件需要手动添加依赖。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-bootstrap<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>配置一旦修改非properties格式的配置，需要在bootstrap.yaml中设置<code>file-extension</code></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-comment">#bootstrap.yaml</span><br><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">application:</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">service-alpha</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-string">localhost:8848</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">namespace:</span> <span class="hljs-string">public</span><br>        <span class="hljs-attr">file-extension:</span> <span class="hljs-string">yaml</span><br></code></pre></td></tr></table></figure>

<p>注意：<code>spring.application.name=service-alpha</code>必须写在<code>bootstrap.properties</code>中才能动态感知配置的变化，写在<code>application.properties</code>中无法感知。</p>
<p>使用<code>@Value</code>获取的配置信息无法动态感知，需要配合使用<code>@RefreshScope</code></p>
<h2 id="服务限流-熔断-降级sentinel"><a href="#服务限流-熔断-降级sentinel" class="headerlink" title="服务限流\熔断\降级sentinel"></a>服务限流\熔断\降级sentinel</h2><p><a target="_blank" rel="noopener" href="https://sentinelguard.io/zh-cn/docs/annotation-support.html">annotation-support (sentinelguard.io)</a></p>
<h3 id="SentinelResource-value-x3D-””-blockHandler-x3D-””"><a href="#SentinelResource-value-x3D-””-blockHandler-x3D-””" class="headerlink" title="@SentinelResource(value&#x3D;””, blockHandler&#x3D;””)"></a>@SentinelResource(value&#x3D;””, blockHandler&#x3D;””)</h3><h4 id="value："><a href="#value：" class="headerlink" title="value："></a>value：</h4><ul>
<li>资源名称，必需项（不能为空）</li>
</ul>
<h4 id="entryType："><a href="#entryType：" class="headerlink" title="entryType："></a>entryType：</h4><ul>
<li>entry 类型，可选项（默认为 <code>EntryType.OUT</code>），作用：标记流量的方向，指明是出口流量，还是入口流量；取值 IN&#x2F;OUT ,默认是OUT。</li>
</ul>
<h4 id="blockHandler-x2F-blockHandlerClass"><a href="#blockHandler-x2F-blockHandlerClass" class="headerlink" title="blockHandler&#x2F;blockHandlerClass"></a>blockHandler&#x2F;blockHandlerClass</h4><ul>
<li>blockHandler 函数访问范围需要是 <code>public</code></li>
<li><strong>返回类型需要与原方法相匹配</strong>，<strong>参数类型需要和原方法相匹配并且最后加一个额外的参数</strong>，类型为 <code>BlockException</code>。</li>
<li>blockHandler 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>blockHandlerClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
<h4 id="fallback"><a href="#fallback" class="headerlink" title="fallback"></a>fallback</h4><p>可选项，用于在抛出异常的时候提供 fallback 处理逻辑。fallback 函数可以针对所有类型的异常（除了 <code>exceptionsToIgnore</code> 里面排除掉的异常类型）进行处理。fallback 函数签名和位置要求：</p>
<ul>
<li>返回值类型必须与原函数返回值类型一致；</li>
<li>方法参数列表需要和原函数一致，或者可以额外多一个 <code>Throwable</code> 类型的参数用于接收对应的异常。</li>
<li>fallback 函数默认需要和原方法在同一个类中。若希望使用其他类的函数，则可以指定 <code>fallbackClass</code> 为对应的类的 <code>Class</code> 对象，注意对应的函数必需为 static 函数，否则无法解析。</li>
</ul>
<p>dashboard去github上下载jar包</p>
<p>启动使用命令<code>java -jar sentinel-dashboard-1.8.3.jar</code></p>
<p>可以加入参数<code>-Dserver.port=8858</code>等</p>
<p>整合SpringCloudAlibaba</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>统一异常处理实现<code>BlockExceptionHandler</code>接口</p>
<p>使用了@SentinelResource注解的方法不会走统一异常处理接口，需要自行指定blockhandler</p>
<h3 id="流控模式"><a href="#流控模式" class="headerlink" title="流控模式"></a>流控模式</h3><h4 id="直接"><a href="#直接" class="headerlink" title="直接"></a>直接</h4><p>对所填的资源直接进行流控</p>
<h4 id="关联"><a href="#关联" class="headerlink" title="关联"></a>关联</h4><p><code>关联资源</code>达到<code>单机阈值</code>触发资源名所填资源的流控</p>
<h4 id="链路"><a href="#链路" class="headerlink" title="链路"></a>链路</h4><p>资源名所填资源达到<code>单机阈值</code>后对<code>入口资源</code>进行流控</p>
<p><strong>使用链路流控模式需要进行以下配置</strong></p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.cloud.sentinel.web-context-unify</span>=<span class="hljs-string">false</span><br></code></pre></td></tr></table></figure>



<h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><h4 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h4><p>指的是流量到达单机阈值后，剩余的流量被直接拒绝</p>
<h4 id="Warm-Up（预热）"><a href="#Warm-Up（预热）" class="headerlink" title="Warm Up（预热）"></a>Warm Up（预热）</h4><p>即预热\冷启动方式，可以设置一个预热时长。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过“冷启动”让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。</p>
<p>冷加载因子：codeFactor默认是3，即请求QPS从threshold&#x2F;3开始，经预热时长逐渐升至设定的QPS阈值。</p>
<h4 id="排队等待"><a href="#排队等待" class="headerlink" title="排队等待"></a>排队等待</h4><p>可以设置超时时间，达到单机阈值后，进行排队</p>
<h3 id="熔断策略"><a href="#熔断策略" class="headerlink" title="熔断策略"></a>熔断策略</h3><h4 id="慢调用比例-SLOW-REQUEST-RATIO"><a href="#慢调用比例-SLOW-REQUEST-RATIO" class="headerlink" title="慢调用比例(SLOW_REQUEST_RATIO)"></a>慢调用比例(SLOW_REQUEST_RATIO)</h4><p>选择以慢调用比例作为阈值，需要设置允许的慢调用RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF-OPEN状态），若接下来的一个请求响应时间小于设置的慢调用RT则结束熔断，若大于设置的慢调用RT则会再次被熔断。</p>
<h4 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a>异常比例</h4><h4 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a>异常数</h4><h3 id="整合Openfeign"><a href="#整合Openfeign" class="headerlink" title="整合Openfeign"></a>整合Openfeign</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">feign.sentinel.enabled</span>: <span class="hljs-string">true</span><br></code></pre></td></tr></table></figure>

<p>写一个类实现feign接口，@FeignClient注解写上fallback的参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@FeignClient(name = &quot;service-bravo&quot;, configuration = FeignConfig.class, fallback = BravoFeignFallback.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">BravoFeign</span> &#123;<br><br>    <span class="hljs-meta">@GetMapping(&quot;/bravo-test/getBravoTestString&quot;)</span><br>    String <span class="hljs-title function_">getBravoTestString</span><span class="hljs-params">()</span>;<br><br>&#125;<br><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">BravoFeignFallback</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">BravoFeign</span>&#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getBravoTestString</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;BravoFeign invoke method getBravoTestString fallback&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h3 id="热点参数流控"><a href="#热点参数流控" class="headerlink" title="热点参数流控"></a>热点参数流控</h3><p>dashboard配置热点参数流控中的资源名必须是@SentinelResource(value&#x3D;”资源名”)中配置的资源名， 热点规则必须配合使用@SentinelResource注解</p>
<h3 id="系统保护规则"><a href="#系统保护规则" class="headerlink" title="系统保护规则"></a>系统保护规则</h3><p>全局规则</p>
<p>Load自适应（仅对Linux&#x2F;Unix-like机器生效）</p>
<p>CPU usage（1.5.0+版本）：当系统CPU使用率超过阈值即触发系统保护（取值范围0.0-1.0），比较灵敏。</p>
<p>平均RT：当单台机器上所有入口流量的平均RT达到阈值即触发系统保护，单位是毫秒。</p>
<p>并发线程数：当单台机器上所有入口流量的并发线程数达到阈值即触发系统保护。</p>
<p>入口QPS：当单台机器上所有入口流量的QPS达到阈值即触发系统保护。</p>
<h3 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h3><p>Sentinel规则的推送有三种模式：</p>
<table>
<thead>
<tr>
<th>推送模式</th>
<th>说明</th>
<th>优点</th>
<th>缺点</th>
</tr>
</thead>
<tbody><tr>
<td>原始模式</td>
<td>API将规则推送至客户端并直接更新到内存中，扩展写数据源(WritableDataSource)</td>
<td>简单，无任何依赖</td>
<td>不保证一致性；规则保存在内存中，重启即消失，严重不建议用于生产环境。</td>
</tr>
<tr>
<td>Pull模式</td>
<td>扩展写数据源(WritableDataSource)，客户端主动向某个规则管理中心定期轮询拉取规则，这个规则中心可以是RDBMS、文件等</td>
<td>简单，无任何依赖；规则持久化</td>
<td>不保证一致性；实时性不保证，拉取过于频繁也可能会有性能问题。</td>
</tr>
<tr>
<td>Push模式</td>
<td>扩展读数据源(ReadableDataSource)，规则中心统一推送，客户端通过注册监听器的方式时刻监听变化，比如使用Nacos、Zookeeper等配置中心。这种方式有更好的实时性和一致性保证。生产环境下一般采用Push模式的数据源。</td>
<td>规则持久化；一致性；快速</td>
<td>引入第三方依赖</td>
</tr>
</tbody></table>
<p>Push模式：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.csp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在nacos中新建配置json格式</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>    <span class="hljs-punctuation">&#123;</span><br>        <span class="hljs-attr">&quot;resource&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;/alpha-test/getTestString&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;controlBehavior&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;count&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">2</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;grade&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">1</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;limitApp&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;default&quot;</span><span class="hljs-punctuation">,</span><br>        <span class="hljs-attr">&quot;strategy&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><br>    <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br></code></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/alibaba/Sentinel/wiki/%E5%A6%82%E4%BD%95%E4%BD%BF%E7%94%A8">如何使用 · alibaba&#x2F;Sentinel Wiki · GitHub</a></p>
<p>添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>	<span class="hljs-attr">cloud:</span><br>		<span class="hljs-attr">sentinel:</span><br>			<span class="hljs-attr">datasource:</span><br>				<span class="hljs-attr">flow-rule:</span> <span class="hljs-comment">#flow-rule为自定义名字</span><br>					<span class="hljs-attr">nacos:</span><br>						<span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>						<span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>						<span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>						<span class="hljs-attr">dataId:</span> <span class="hljs-string">order-sentinel-flow-rule</span><br>						<span class="hljs-attr">ruleType:</span> <span class="hljs-string">flow</span> <span class="hljs-comment">#从RuleType类中查看的类型</span><br></code></pre></td></tr></table></figure>



<h2 id="分布式事务Seata"><a href="#分布式事务Seata" class="headerlink" title="分布式事务Seata"></a>分布式事务Seata</h2><p>Seata是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata为用户提供了AT、TCC、SAGA和XA事务模式，为用户打造一站式的分布式解决方案。AT模式是阿里首推的模式，阿里云上有商用版本的GTS（Globle Transaction Service全局事务服务）</p>
<p>官网：<a target="_blank" rel="noopener" href="https://seata.io/zh-cn/">Seata</a></p>
<h3 id="Seata的三大角色"><a href="#Seata的三大角色" class="headerlink" title="Seata的三大角色"></a>Seata的三大角色</h3><p>TC(Transaction Coordinator)- 事务协调者</p>
<ul>
<li>维护全局和分支事务的状态，驱动全局事务提交或回滚</li>
</ul>
<p>TM(Transaction Manager)- 事务管理器</p>
<ul>
<li>定义全局事务范围：开始全局事务、提交或回滚全局事务。</li>
</ul>
<p>RM(Resource Manager)- 资源管理器</p>
<ul>
<li>管理分支事务处理的资源，与TC交谈以注册分支事务和报告分支事务的状态，并驱动分支事务提交或回滚。</li>
</ul>
<p>其中TC为单独部署的Server服务端，TM和RM为嵌入到应用中的Client客户端。</p>
<h3 id="AT模式"><a href="#AT模式" class="headerlink" title="AT模式"></a>AT模式</h3><p>AT模式是一种无侵入的分布式事务解决方案。</p>
<p>阿里seata框架实现了该模式。</p>
<p>在AT模式下，用户只需关注自己的“业务SQL”，用户的“业务SQL”作为一阶段，Seata框架会自动生成事务的二阶段提交和回滚操作。</p>
<p>AT模式如何做到对业务的无侵入：</p>
<ul>
<li>一阶段</li>
</ul>
<p>在一阶段，Seata会拦截“业务SQL”，首先解析SQL语义，找到“业务SQL”要更新的业务数据，在业务数据被更新前，将其保存成“before image”，然后执行“业务SQL”更新业务数据，在业务数据更新之后，再将其保存成“after image”，最后生成行锁。以上操作全部在一个数据库事务内完成，这样保证了一阶段操作的原子性。</p>
<ul>
<li>二阶段提交</li>
</ul>
<p>二阶段如果是提交的话，因为“业务SQL”在一阶段已经提交至数据库，所以Seata框架只需要将一阶段保存的快照数据和行锁删掉，完成数据清理即可。</p>
<ul>
<li>二阶段回滚</li>
</ul>
<p>二阶段如果是回滚的话，Seata就需要回滚一阶段已经执行的“业务SQL”，还原业务数据。回滚的方式便是用“before image”还原业务数据；但在还原之前要首先要校验脏写，对比“数据库当前业务数据”和“after image”，如果两份数据完全一致就说明没有脏写，可以还原业务数据，如果不一致就说明有脏写，出现脏写就需要转人工处理。</p>
<h3 id="TCC模式"><a href="#TCC模式" class="headerlink" title="TCC模式"></a>TCC模式</h3><p>1.侵入性比较强，并且得自己实现相关事务控制逻辑</p>
<p>2.整个过程基本没有锁，性能更高</p>
<p>TCC模式需要用户根据自己的业务场景实现Try、Confirm和Cancel三个操作；事务发起方在一阶段执行Try方式，在二阶段提交执行confirm方法，二阶段回滚执行cancel方法。</p>
<h3 id="Seata快速开始"><a href="#Seata快速开始" class="headerlink" title="Seata快速开始"></a>Seata快速开始</h3><p>Seatac Server（TC）环境搭建</p>
<p>Server端存储模式（store.mode）支持三种：</p>
<ul>
<li>file：单机模式，全局事务会话信息内存中读写并持久化本地文件root.data，性能较高（默认）</li>
<li>db：(mysql5.7+)高可用模式，全局事务会话信息通过db共享，相应性能差些<ul>
<li>打开conf&#x2F;file.conf</li>
<li>修改mode&#x3D;”db”</li>
<li>修改数据库连接信息（url&#x2F;username&#x2F;password）</li>
<li>创建数据库seata</li>
<li>新建表：可以去seata提供的资源信息中下载：<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/master/script">seata&#x2F;script at master · seata&#x2F;seata · GitHub</a></li>
</ul>
</li>
</ul>
</li>
<li>redis：Seata-Server1.3及以上版本支持，性能较高，存在事务信息丢失的风险，需提前配置适合当前场景的redis持久化配置</li>
</ul>
<p>资源目录</p>
<ul>
<li>client：存放client端sql脚本，参数配置</li>
<li>config-center：各个配置中心参数导入脚本，config.txt（包含server和client，原名nacos-config.sh）为通用参数文件</li>
<li>server：server端数据库脚本及各个容器配置</li>
</ul>
<h3 id="db存储模式-Nacos（注册-amp-配置中心）部署（高可用）"><a href="#db存储模式-Nacos（注册-amp-配置中心）部署（高可用）" class="headerlink" title="db存储模式+Nacos（注册&amp;配置中心）部署（高可用）"></a>db存储模式+Nacos（注册&amp;配置中心）部署（高可用）</h3><ol>
<li>修改conf&#x2F;registry.conf中注册中心和配置中心 <code>type</code>和nacos相关配置（config也可以使用本地文件）</li>
<li><a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/master/script">seata&#x2F;script at master · seata&#x2F;seata · GitHub</a>下载config-center中的文件，修改<code>config.txt</code>中的相关配置：修改<code>store.mode=DB</code>及修改<code>store.db</code>相关配置。</li>
<li>执行nacos&#x2F;nacos-config.sh（可以使用git-bash.exe，需要设置参数如-u username和-w password）将<code>config.txt</code>中的配置注册到配置中心，执行后应该会产生4个失败，分别是config.txt中4个未配置的参数，不影响单机使用（seata1.4.2版本不需要）。</li>
<li>启动seata，执行seata解压目录中bin&#x2F;seata-server.bat</li>
</ol>
<p>seata支持的启动参数</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>全写</th>
<th>作用</th>
<th>备注</th>
</tr>
</thead>
<tbody><tr>
<td>-h</td>
<td>–host</td>
<td>指定在注册中心注册的IP</td>
<td>不指定时获取当前的IP，外部访问部署在云环境和容器中的server建议指定</td>
</tr>
<tr>
<td>-p</td>
<td>–port</td>
<td>指定server启动的端口</td>
<td>默认为8091</td>
</tr>
<tr>
<td>-m</td>
<td>–storeMode</td>
<td>事务日志存储方式</td>
<td>支持file，db，redis，默认为file，redis需seata-server1.3版本以上</td>
</tr>
<tr>
<td>-n</td>
<td>–serverNode</td>
<td>用于指定seata-server节点ID</td>
<td>如1，2，3…，默认为1</td>
</tr>
<tr>
<td>-e</td>
<td>–seataEnv</td>
<td>指定seata-server运行环境</td>
<td>如dev，test等，服务启动时会使用registry-dev.conf这样的配置</td>
</tr>
</tbody></table>
<h3 id="Seata-Client快速开始"><a href="#Seata-Client快速开始" class="headerlink" title="Seata Client快速开始"></a>Seata Client快速开始</h3><p>第一步：添加pom依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第二步：各微服务对应数据库中添加undo_log表</p>
<p><a target="_blank" rel="noopener" href="https://github.com/seata/seata/tree/master/script">seata&#x2F;script at master · seata&#x2F;seata · GitHub</a></p>
<p>&#x2F;client&#x2F;at&#x2F;db&#x2F;mysql.sql</p>
<p>第三步：Client端加入对应的配置中心</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">seata:</span><br>  <span class="hljs-attr">registry:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">application:</span> <span class="hljs-string">seata-server</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">nacos</span><br>      <span class="hljs-attr">group:</span> <span class="hljs-string">SEATA_GROUP</span><br>  <span class="hljs-attr">config:</span><br>    <span class="hljs-attr">type:</span> <span class="hljs-string">nacos</span><br>    <span class="hljs-attr">nacos:</span><br>      <span class="hljs-attr">server-addr:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8848</span><br>      <span class="hljs-attr">group :</span> <span class="hljs-string">&quot;SEATA_GROUP&quot;</span><br>      <span class="hljs-attr">namespace:</span> <span class="hljs-string">&quot;&quot;</span><br>      <span class="hljs-attr">username:</span> <span class="hljs-string">&quot;nacos&quot;</span><br>      <span class="hljs-attr">password:</span> <span class="hljs-string">&quot;nacos&quot;</span><br></code></pre></td></tr></table></figure>

<p>第四步：修改seata解压目录中 registry.conf，配置nacos作为registry.type和config.type，并修改配置中心相关配置。</p>
<p>第五步：为seata新建库表</p>
<p>第六步：启动seata</p>
<h2 id="网关gateway"><a href="#网关gateway" class="headerlink" title="网关gateway"></a>网关gateway</h2><p>前端直接访问微服务会存在诸多的问题：</p>
<ul>
<li>每个业务都会需要鉴权、限流、权限校验、跨域等逻辑，可以将这些逻辑抽离出来统一放到一个地方做</li>
<li>如果业务量比较简单的话，这种方式前期不会有什么问题，但随着业务越来越复杂，比如淘宝、亚马逊打开一个页面可能会涉及到数百个微服务协同工作，如果每一个微服务都分配一个域名的话，一方面客户端代码会很难维护，涉及到数百个域名，另一方面是连接数瓶颈，想象一下你打开一个APP，通过抓包发现涉及到了数百个远程调用，这在移动端下会显得非常低效。</li>
<li>服务拆分麻烦</li>
</ul>
<p>所谓的API网关，就是指系统的统一入口，它封装了应用程序的内部结构，为客户端提供统一的服务，一些与业务本身功能无关的公共逻辑可以在这里实现，比如认证、鉴权、监控、路由转发等等。</p>
<h3 id="Spring-Cloud-Gateway功能特性"><a href="#Spring-Cloud-Gateway功能特性" class="headerlink" title="Spring Cloud Gateway功能特性"></a>Spring Cloud Gateway功能特性</h3><ul>
<li>基于Spring Framework 5，Project Reactor和Spring Boot 2.0进行构建；</li>
<li>动态路由：能够匹配任何请求属性；</li>
<li>支持路径重写；</li>
<li>集成Spring Cloud服务发现功能（Nacos、Eruka）；</li>
<li>可集成流控降级功能（Sentinel、Hystrix）；</li>
<li>可以对路由指定易于编写的Predicate（断言）和Filter（过滤器）；</li>
</ul>
<h3 id="核心概念"><a href="#核心概念" class="headerlink" title="核心概念"></a>核心概念</h3><ul>
<li>路由（route）</li>
</ul>
<p>路由是网关中最基础的部分，路由信息包括一个ID、一个目的URL、一组断言工厂、一组Filter组成。如果断言为真，则说明请求的URL和配置的路由匹配。</p>
<ul>
<li>断言（predicate）</li>
</ul>
<p>Java8中的断言函数，SpringCloud Gateway中的断言函数类型是Spring5.0框架中的ServerWebExchange。断言函数允许开发者去定义匹配的Http request中的任何信息，比如请求头和参数等。</p>
<ul>
<li>过滤器（Filter）</li>
</ul>
<p>SpringCloud Gateway中的Filter分为Gateway Filter和Global Filter。Filter可以对请求和响应进行处理。</p>
<h3 id="SpringCloud-Gateway快速开始"><a href="#SpringCloud-Gateway快速开始" class="headerlink" title="SpringCloud Gateway快速开始"></a>SpringCloud Gateway快速开始</h3><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加配置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">routes:</span> <span class="hljs-comment">#数组路由[路由 就是指定当前请求满足什么条件的时候转到哪个微服务]</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">id:</span> <span class="hljs-string">gateway</span><br>          <span class="hljs-attr">uri:</span> <span class="hljs-string">lb://service-alpha</span>   <span class="hljs-comment">#请求要转发到的地址[http://127.0.0.1:8001]，或从注册中心获取服务</span><br>          <span class="hljs-attr">order:</span> <span class="hljs-number">1</span>    <span class="hljs-comment">#路由的级别，数字越小级别越高</span><br>          <span class="hljs-attr">predicates:</span> <span class="hljs-comment">#断言（就是路由转发要满足的条件），当请求路径满足Path指定的规则时，才进行路由转发</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">Path=/service-alpha/**</span><br>          <span class="hljs-attr">filters:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">StripPrefix=1</span> <span class="hljs-comment">#转发之前去掉第一层路径</span><br></code></pre></td></tr></table></figure>

<p>注意：需要引入openfeign依赖才能在uri处使用负载均衡进行服务调用</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br><span class="hljs-comment">#      routes: #数组路由[路由 就是指定当前请求满足什么条件的时候转到哪个微服务]</span><br><span class="hljs-comment">#        - id: gateway</span><br><span class="hljs-comment">#          uri: lb://service-alpha   #请求要转发到的地址[http://127.0.0.1:8001]，或从注册中心获取服务</span><br><span class="hljs-comment">#          order: 1    #路由的级别，数字越小级别越高</span><br><span class="hljs-comment">#          predicates: #断言（就是路由转发要满足的条件），当请求路径满足Path指定的规则时，才进行路由转发</span><br><span class="hljs-comment">#            - Path=/service-alpha/**</span><br><span class="hljs-comment">#          filters:</span><br><span class="hljs-comment">#            - StripPrefix=1 #转发之前去掉第一层路径</span><br>      <span class="hljs-attr">discovery:</span><br>        <span class="hljs-attr">locator:</span><br>          <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br></code></pre></td></tr></table></figure>

<p>使用<code>spring.cloud.gateway.discovery.locator.enabled=true</code>会自动根据路径中的第一层路径寻找服务，且会自动去掉此路径（虽然简单但不太常用，不直观）</p>
<h3 id="路由断言工厂（Route-Predicate-Factories）配置"><a href="#路由断言工厂（Route-Predicate-Factories）配置" class="headerlink" title="路由断言工厂（Route Predicate Factories）配置"></a>路由断言工厂（Route Predicate Factories）配置</h3><p>作用：当请求gateway的时候，使用断言对请求进行匹配，如果匹配成功就路由转发，如果匹配失败就返回404.</p>
<p>SpringCloud Gateway包括许多内置的断言工厂，所有这些断言都与HTTP请求的不同属性匹配。具体如下：</p>
<ul>
<li>基于DateTime类型的断言工厂</li>
</ul>
<p>此类型的断言根据时间做判断，主要有三个：</p>
<p>AfterRoutePredicateFactory：接收一个日期参数，判断请求日期是否晚于指定日期</p>
<p>BeforeRoutePredicateFactory：接收一个日期参数，判断请求日期是否早于指定日期</p>
<p>BetweenRoutePredicateFactory：接收两个日期参数，判断请求日期是否在指定时间段</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">predicates:</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">After=2022-09-25T18:02:59.789+08:00[Asia/Shanghai]</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于远程地址的断言工厂</li>
</ul>
<p>RemoteAddrRoutePredicateFactory：接收一个ip地址段，判断请求主机地址是否在地址段中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">predicates:</span><br>	<span class="hljs-bullet">-</span> <span class="hljs-string">RemoteAddr=192.167.1.1/24</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Cookie的断言工厂</li>
</ul>
<p>CookieRoutePredicateFactory：接收两个参数，cookie名字和一个正则表达式，判断请求cookie是否具有给定名称且值与正则表达式匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Cookie=chocolate,ch.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Header的断言工厂</li>
</ul>
<p>HeaderRoutePredicateFactory：接收两个参数，标题名称和正则表达式。判断请求Header是否具有给定名称且值与正则表达式匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Header=X-Request-Id,</span> <span class="hljs-string">\d+</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Host的断言工程</li>
</ul>
<p>HostRoutePredicateFactory：接收一个参数，主机名模式。判断请求的Host是否满足匹配规则。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Host=**.testhost.org</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Method请求方法的断言工厂</li>
</ul>
<p>MethodRoutePredicateFactory：接收一个参数，判断请求类型是否跟指定类型匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Method=GET</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Path请求路径的断言工厂</li>
</ul>
<p>PathRoutePredicateFactory：接收一个参数，判断请求的URI部分是否满足路径规则。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-bullet">-</span> <span class="hljs-string">Path=/foo/&#123;segment&#125;</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于Query请求参数的断言工厂</li>
</ul>
<p>QueryRoutePredicateFactory：接收两个参数，请求param和正则表达式，判断请求参数是否具有给定名称且值与正则表达式匹配。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">-Query=bar,</span> <span class="hljs-string">ba.</span><br></code></pre></td></tr></table></figure>

<ul>
<li>基于路由权重的断言工厂</li>
</ul>
<p>WeightRoutePredicateFactory：接收一个[组名，权重]，然后对于同一个组内的路由按照权重转发。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">routes:</span><br>	<span class="hljs-string">-id:</span> <span class="hljs-string">weight_route1</span><br>	 <span class="hljs-attr">uri:</span> <span class="hljs-string">host1</span><br>     <span class="hljs-attr">predicates:</span><br>     	<span class="hljs-string">-Path=/product/**</span><br>     	<span class="hljs-string">-Weight=group3,1</span><br>     <span class="hljs-string">-id:</span> <span class="hljs-string">weight_route2</span><br>	 <span class="hljs-attr">uri:</span> <span class="hljs-string">host2</span><br>     <span class="hljs-attr">predicates:</span><br>     	<span class="hljs-string">-Path=/product/**</span><br>     	<span class="hljs-string">-Weight=group3,9</span><br></code></pre></td></tr></table></figure>

<h3 id="自定义断言工厂"><a href="#自定义断言工厂" class="headerlink" title="自定义断言工厂"></a>自定义断言工厂</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.1/reference/html/">Spring Cloud Gateway</a></p>
<p>自定义路由断言工厂需要继承<code>AbstractRoutePredicateFactory</code>类，重写apply方法的逻辑。在apply方法中可以通过exchange.getRequest()拿到ServletHttpRequest对象，从而可以获取到请求的参数、请求方式、请求头等信息。</p>
<ol>
<li><p>必须为spring组件</p>
</li>
<li><p>类命名必须加上RoutePredicateFactory作为结尾。</p>
</li>
<li><p>必须继承<code>AbstractRoutePredicateFactory</code></p>
</li>
<li><p>必须声明静态内部类，声明属性来接收配置文件中对应的断言的信息</p>
</li>
</ol>
<p>参考官方的写法</p>
<h3 id="局部过滤器"><a href="#局部过滤器" class="headerlink" title="局部过滤器"></a>局部过滤器</h3><p><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-cloud-gateway/docs/3.1.1/reference/html/#gatewayfilter-factories">Spring Cloud Gateway</a></p>
<h3 id="全局过滤器"><a href="#全局过滤器" class="headerlink" title="全局过滤器"></a>全局过滤器</h3><p>针对所有路由请求，一旦定义就会投入使用</p>
<p>写一个类实现<code>GlobalFilter</code>接口</p>
<h3 id="跨域处理"><a href="#跨域处理" class="headerlink" title="跨域处理"></a>跨域处理</h3><p>配置文件方式</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">spring:</span><br>  <span class="hljs-attr">cloud:</span><br>    <span class="hljs-attr">gateway:</span><br>      <span class="hljs-attr">globalcors:</span><br>        <span class="hljs-attr">cors-configurations:</span><br>          <span class="hljs-string">&#x27;[/**]&#x27;</span><span class="hljs-string">:</span> <span class="hljs-comment">#允许跨域访问的资源</span><br>            <span class="hljs-attr">allowedOrigins:</span> <span class="hljs-string">&quot;*&quot;</span> <span class="hljs-comment">#跨域允许来源</span><br>            <span class="hljs-attr">allowedMethods:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">GET</span><br></code></pre></td></tr></table></figure>

<h3 id="整合Sentinel流控降级"><a href="#整合Sentinel流控降级" class="headerlink" title="整合Sentinel流控降级"></a>整合Sentinel流控降级</h3><p>添加依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.alibaba.cloud<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-cloud-alibaba-sentinel-gateway<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">sentinel:</span><br>	<span class="hljs-attr">transport:</span><br>		<span class="hljs-attr">dashboard:</span> <span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-string">:8080</span><br></code></pre></td></tr></table></figure>





<h2 id="链路追踪SkyWalking"><a href="#链路追踪SkyWalking" class="headerlink" title="链路追踪SkyWalking"></a>链路追踪SkyWalking</h2><p>skywalking8.7.0之后的版本，agent的相关代码被抽离出skywalking当中，需要自行下载agent。</p>
<p>执行startup.cmd启动skywalking客户端</p>
<p>启动成功后会启动两个服务，一个是skywalking-oap-server，一个是skywalking-web-ui</p>
<p>skywalking-oap-server服务启动后会暴露11800 和 12800 两个端口，分别为收集监控数据的端口11800和接受前端请求的端口12800，修改端口可以修改config&#x2F;applicaiton.yml<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/u012267926/article/details/119793247">https://blog.csdn.net/u012267926/article/details/119793247</a></p>
<p>skywalking-web-ui服务会占用 8080 端口， 修改端口可以修改webapp&#x2F;webapp.yml</p>
<p>windows的idea中在VM  options中添加以下参数后启动</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs routeros"><span class="hljs-comment">#skywalking-agent.jar的磁盘路径</span><br>-javaagent:D:\programming\apache-skywalking-java-agent-8.10.0\skywalking-agent\skywalking-agent.jar<br><span class="hljs-comment">#在skywalking上显示的服务名</span><br><span class="hljs-attribute">-DSW_AGENT_NAME</span>=service-gateway<br><span class="hljs-comment">#skywalking的collector服务的ip和端口</span><br><span class="hljs-attribute">-DSW_AGENT_COLLECTOR_BACKEND_SERVICES</span>=127.0.0.1:11800<br></code></pre></td></tr></table></figure>

<p>linux命令</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs routeros">java -javaagent:/user/skywalking-agent.jar <span class="hljs-attribute">-DSW_AGENT_NAME</span>=gateway <span class="hljs-attribute">-DSW_AGENT_COLLECTOR_BACKEND_SERVICES</span>=127.0.0.1:11800 -jar service-gateway.jar<br></code></pre></td></tr></table></figure>

<h3 id="在拓扑图中显示gateway服务"><a href="#在拓扑图中显示gateway服务" class="headerlink" title="在拓扑图中显示gateway服务"></a>在拓扑图中显示gateway服务</h3><p>需要从&#x2F;skywalking-agent&#x2F;optional-plugins中复制一份<code>apm-spring-cloud-gateway</code>插件到&#x2F;skywalking-agent&#x2F;plugins中</p>
<h3 id="使用MySQL持久化"><a href="#使用MySQL持久化" class="headerlink" title="使用MySQL持久化"></a>使用MySQL持久化</h3><p>修改config&#x2F;application.yml，将<code>storage.selector</code>的h2修改为mysql，并修改MySQL配置</p>
<p>建好数据库后skywalking启动时会自动把表建好</p>
<p><strong>注意：oap服务依赖中没有mysql驱动，需要自行复制一份mysql驱动放到&#x2F;oap-libs目录中</strong></p>
<h3 id="自定义链路追踪"><a href="#自定义链路追踪" class="headerlink" title="自定义链路追踪"></a>自定义链路追踪</h3><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.skywalking<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apm-toolkit-trace<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在业务方法上添加<code>@Trace</code>注解</p>
<p>记录方法参数和返回值使用<code>@Tag</code>&#x2F;<code>@Tags</code>注解（需要配合<code>@Trace</code>），给一个key（自定义），需要记录返回值则对应key的value&#x3D;”returnedObj”，若需要记录参数则value&#x3D;”arg[0]”</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Tags(&#123;@Tag(key=&quot;param&quot;, value=&quot;arg[0]&quot;),</span><br><span class="hljs-meta">       @Tag(key=&quot;returnVal&quot;, value=&quot;returnedObj&quot;)&#125;)</span><br></code></pre></td></tr></table></figure>

<p><strong>返回的是一个对象的话需要重写该对象的toString方法，否则显示的返回值为该对象的地址</strong></p>
<h3 id="集成日志框架"><a href="#集成日志框架" class="headerlink" title="集成日志框架"></a>集成日志框架</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Blueeyedboy521/article/details/126509520"> SpringCloud链路追踪SkyWalking-第六章-日志采集_Blueeyedboy521的博客-CSDN博客_skywalking采集业务日志</a></p>
<ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.skywalking<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>apm-toolkit-logback-1.x<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>9.1.0<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>



<ol start="2">
<li>logback配置文件中<appender><encoder><layout class=....TraceIdPatternLogbackLayut>,layout指定SkyWalking中的Layout，可以在<pattern>中使用%tid输出trace_id</li>
</ol>
<p>如果需要使用skywalking记录所有项目的日志可以在logback配置中加入以下配置按需打印</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">appender</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;grpc-log&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.ConsoleAppender&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">encoder</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;ch.qos.logback.core.encoder.LayoutWrappingEncoder&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">layout</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.skywalking.apm.toolkit.log.logback.v1.x.TraceIdPatternLogbackLayout&quot;</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">Pattern</span>&gt;</span>%d&#123;yyyy-MM-dd HH:mm:ss.SSS&#125; [%tid] [%thread] %-5level %logger&#123;36&#125; -%msg%n<span class="hljs-tag">&lt;/<span class="hljs-name">Pattern</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">layout</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">encoder</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">appender</span>&gt;</span><br></code></pre></td></tr></table></figure>


                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" class="category-chain-item">学习笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>SpringCloud Alibaba</div>
      <div>https://carl-chu.github.io/2022/09/29/SpringCloud Alibaba/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>CarlChu</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年9月29日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2023/01/27/Golang/" title="Golang">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Golang</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/08/15/RocketMQ/" title="RocketMQ">
                        <span class="hidden-mobile">RocketMQ</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
